// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

// Organization managing HUBZone certification
model Organization {
  id              String    @id @default(cuid())
  name            String
  einNumber       String?   @unique
  dunsNumber      String?
  uei             String?   // Unique Entity ID (replaced DUNS)
  cageCode        String?
  hubzoneNumber   String?   // SBA HUBZone certification number
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  employees       Employee[]
  locations       Location[]
  certifications  Certification[]
  
  // Agent constellation relations
  agentTasks          AgentTask[]
  complianceSnapshots ComplianceSnapshot[]
  complianceAlerts    ComplianceAlert[]
  
  // Additional agent relations
  contractOpportunities ContractOpportunity[]
  teamingPartners       TeamingPartner[]
  attemptToMaintain     AttemptToMaintain[]
  complianceEvents      ComplianceEvent[]
  documents             Document[]
}

// Employee records for residency tracking
model Employee {
  id              String    @id @default(cuid())
  organizationId  String
  firstName       String
  lastName        String
  email           String?
  hireDate        DateTime
  isActive        Boolean   @default(true)
  
  // Address info
  streetAddress   String
  city            String
  state           String
  zipCode         String
  
  // Computed fields stored for performance
  isHubzoneResident Boolean  @default(false)
  hubzoneType       String?  // QCT, QNMC, DDA, etc.
  lastVerified      DateTime?
  
  // Agent constellation fields (2025 HUBZone rules)
  isLegacyEmployee    Boolean   @default(false)  // Grandfathered employee (max 4)
  residencyStartDate  DateTime?                   // For 90-day qualification tracking
  censusTract         String?                     // Census tract ID
  atRiskRedesignation Boolean   @default(false)  // In redesignated area
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  addressVerifications AddressVerification[]
  
  @@index([organizationId])
  @@index([isHubzoneResident])
  @@index([isLegacyEmployee])
  @@index([organizationId, isActive])
}

// Business locations
model Location {
  id              String    @id @default(cuid())
  organizationId  String
  name            String
  isPrincipalOffice Boolean @default(false)
  
  streetAddress   String
  city            String
  state           String
  zipCode         String
  
  // Geospatial data
  latitude        Float?
  longitude       Float?
  
  // HUBZone status
  isInHubzone     Boolean   @default(false)
  hubzoneType     String?
  lastVerified    DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
}

// Certification tracking
model Certification {
  id              String    @id @default(cuid())
  organizationId  String
  
  status          CertificationStatus @default(PENDING)
  submittedAt     DateTime?
  approvedAt      DateTime?
  expiresAt       DateTime?
  
  // Compliance snapshot at time of certification
  totalEmployees  Int       @default(0)
  hubzoneResidents Int      @default(0)
  compliancePercent Float   @default(0)
  
  notes           String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
  @@index([status])
}

enum CertificationStatus {
  PENDING
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  DENIED
  EXPIRED
  RECERTIFICATION_DUE
}

// HUBZone geographic data (populated from SBA data)
model HubzoneArea {
  id              String    @id @default(cuid())
  geoId           String    @unique
  name            String
  state           String
  hubzoneType     String    // QCT, QNMC, DDA, BRAC, etc.
  
  // Census tract or county info
  tractCode       String?
  countyFips      String?
  
  // Effective dates
  effectiveFrom   DateTime
  effectiveTo     DateTime?
  isActive        Boolean   @default(true)
  
  // GeoJSON boundary stored as text (parsed at query time)
  boundaryGeoJson String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([state])
  @@index([hubzoneType])
  @@index([isActive])
}

// Address lookup cache
model AddressLookupCache {
  id              String    @id @default(cuid())
  
  // Input address (normalized)
  inputAddress    String    @unique
  
  // Geocoded result
  latitude        Float
  longitude       Float
  
  // HUBZone result
  isHubzone       Boolean
  hubzoneType     String?
  hubzoneAreaId   String?
  
  // Cache metadata
  expiresAt       DateTime
  createdAt       DateTime  @default(now())
  
  @@index([inputAddress])
  @@index([expiresAt])
}

// ============================================================================
// AGENT CONSTELLATION MODELS
// ============================================================================

// Task queue for all agent operations
model AgentTask {
  id              String    @id @default(cuid())
  agentType       String    // nexus, sentinel, cartograph, workforce, etc.
  taskType        String    // specific operation being performed
  status          String    @default("pending") // pending, processing, completed, failed
  priority        Int       @default(5) // 1 = critical, 5 = routine
  input           Json
  output          Json?
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt       DateTime  @default(now())
  completedAt     DateTime?
  executionTimeMs Int?
  errorMessage    String?

  @@index([organizationId])
  @@index([status])
  @@index([agentType])
  @@index([createdAt])
}

// Point-in-time compliance snapshots
model ComplianceSnapshot {
  id                   String   @id @default(cuid())
  organizationId       String
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Core metrics
  totalEmployees       Int
  hubzoneEmployees     Int
  compliancePercentage Float
  legacyEmployeeCount  Int      @default(0)
  
  // Risk assessment
  riskScore            Float    @default(0)
  complianceStatus     String   // compliant, at_risk, non_compliant, grace_period
  
  // Grace period tracking
  gracePeriodActive    Boolean  @default(false)
  gracePeriodEnd       DateTime?
  
  // Projections (JSON: { days30, days90, days180 })
  projections          Json?
  
  snapshotDate         DateTime @default(now())

  @@index([organizationId])
  @@index([snapshotDate])
  @@index([complianceStatus])
}

// Proactive compliance alerts
model ComplianceAlert {
  id              String    @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  severity        String    // critical, warning, info
  type            String    // compliance_drop, employee_relocation, map_change, etc.
  source          String    @default("sentinel") // which agent generated
  
  title           String
  description     String    @db.Text
  
  actionRequired  Boolean   @default(false)
  suggestedAction String?
  dueDate         DateTime?
  
  status          String    @default("active") // active, acknowledged, resolved, dismissed
  acknowledgedAt  DateTime?
  resolvedAt      DateTime?
  resolution      String?
  
  createdAt       DateTime  @default(now())

  @@index([organizationId])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
}

// Learning events for ML training
model LearningEvent {
  id             String   @id @default(cuid())
  eventType      String   // agent_taskType format
  inputData      Json
  outputData     Json
  outcome        String?  // success, failure, partial
  organizationId String?
  metadata       Json?
  createdAt      DateTime @default(now())

  @@index([eventType])
  @@index([outcome])
  @@index([createdAt])
}

// HUBZone map change tracking
model HubzoneMapChange {
  id                    String    @id @default(cuid())
  censusTract           String
  county                String?
  state                 String?
  
  changeType            String    // designated, redesignated, expired
  previousStatus        String?
  newStatus             String
  
  effectiveDate         DateTime
  expirationDate        DateTime?
  
  detectedAt            DateTime  @default(now())
  affectedOrganizations Json?     // { orgId: true, ... }

  @@index([censusTract])
  @@index([changeType])
  @@index([effectiveDate])
}

// ============================================================================
// CAPTURE AGENT - Contract Opportunities
// ============================================================================

model ContractOpportunity {
  id                  String    @id @default(cuid())
  organizationId      String
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Core opportunity data
  title               String
  agency              String
  noticeId            String
  setAside            String    // hubzone, hubzone_sole, 8a, sdvosb, wosb, small_business, full_open
  estimatedValue      Float?
  responseDeadline    DateTime?
  naicsCode           String?
  placeOfPerformance  String?
  description         String?   @db.Text
  
  // Status tracking
  status              String?   @default("discovered") // discovered, analyzing, qualified, pursuing, bid_submitted, won, lost, no_bid
  matchScore          Float?
  winProbability      Float?
  
  // Analysis data
  analysisData        Json?
  bidDecision         Json?
  
  // Contract details
  isRecompete         Boolean   @default(false)
  incumbentName       String?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@unique([organizationId, noticeId])
  @@index([organizationId])
  @@index([status])
  @@index([setAside])
  @@index([responseDeadline])
}

// ============================================================================
// DIPLOMAT AGENT - Teaming Partners
// ============================================================================

model TeamingPartner {
  id              String    @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  name            String
  cageCode        String?
  uei             String?
  
  certifications  String[]  // Array of certification types
  capabilities    String[]  // Array of capability areas
  
  status          String    @default("prospect") // prospect, contacted, active, inactive
  synergyScore    Float     @default(0)
  
  contactName     String?
  contactEmail    String?
  contactPhone    String?
  
  notes           String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([organizationId])
  @@index([status])
}

// ============================================================================
// ADVOCATE AGENT - Regulatory Updates
// ============================================================================

model RegulatoryUpdate {
  id              String    @id @default(cuid())
  
  source          String    // SBA, Federal Register, etc.
  title           String
  category        String    // rule_change, guidance, policy, announcement
  
  effectiveDate   DateTime?
  summary         String    @db.Text
  fullText        String?   @db.Text
  
  impact          String    // high, medium, low
  affectedAreas   String[]  // compliance, hiring, certification, etc.
  actionRequired  Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([effectiveDate])
  @@index([impact])
  @@index([category])
}

// ============================================================================
// GUARDIAN AGENT - Audit Support Models
// ============================================================================

// Attempt to Maintain documentation (for grace period)
model AttemptToMaintain {
  id              String    @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  actionType      String    // hiring_effort, relocation_assistance, job_posting, partnership, etc.
  description     String    @db.Text
  evidence        String?   @db.Text
  documentedBy    String?
  
  createdAt       DateTime  @default(now())

  @@index([organizationId])
  @@index([actionType])
  @@index([createdAt])
}

// Address verification records
model AddressVerification {
  id              String    @id @default(cuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  address         String
  verifiedAt      DateTime
  isHubzone       Boolean
  hubzoneType     String?
  censusTract     String?
  
  source          String    // SBA_API, manual, CARTOGRAPH
  confidence      Float?
  
  createdAt       DateTime  @default(now())

  @@index([employeeId])
  @@index([verifiedAt])
}

// Compliance event log
model ComplianceEvent {
  id              String    @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  eventType       String    // hire, termination, address_change, verification, status_change
  details         Json
  source          String    // SENTINEL, WORKFORCE, GUARDIAN, etc.
  
  createdAt       DateTime  @default(now())

  @@index([organizationId])
  @@index([eventType])
  @@index([createdAt])
}

// ============================================================================
// ARCHIVIST AGENT - Document Management
// ============================================================================

model Document {
  id              String    @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  title           String
  type            String    // compliance_report, employee_roster, certification_package, audit_package, etc.
  content         String?   @db.Text
  metadata        Json?
  tags            String[]
  
  fileUrl         String?   // For uploaded documents
  fileSize        Int?
  mimeType        String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([organizationId])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// FEEDBACK LOOP SYSTEM MODELS
// ============================================================================

// Feedback Log - Captures all feedback from stress tests, user interactions, and agent executions
model FeedbackLog {
  id                String   @id @default(cuid())
  
  // Source identification
  sourceType        String   // stress_test, user_interaction, agent_execution, external_api
  agentId           String   // Which agent generated/received feedback
  taskType          String   // What task was being executed
  scenarioId        String?  // For stress tests
  organizationId    String?  // If org-specific
  
  // Execution details
  executionInput    Json?
  executionOutput   Json?
  executionTimeMs   Int?
  executionSuccess  Boolean  @default(true)
  errorMessage      String?
  
  // Feedback classification
  category          String   // performance, accuracy, ux, edge_case, bug, compliance, security
  severity          String   // critical, high, medium, low
  description       String   @db.Text
  expectedBehavior  String?
  actualBehavior    String   @db.Text
  userImpact        String?
  
  // Resolution tracking
  resolutionStatus  String   @default("open") // open, in_progress, resolved, wont_fix, deferred
  buildVersion      String?
  commitHash        String?
  changeDescription String?
  resolvedAt        DateTime?
  verifiedBy        String?
  
  // Impact assessment
  usersAffected     Int      @default(0)
  complianceRisk    Boolean  @default(false)
  dataIntegrityRisk Boolean  @default(false)
  securityRisk      Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([agentId])
  @@index([category])
  @@index([severity])
  @@index([resolutionStatus])
  @@index([createdAt])
}

// Agent Execution Log - Tracks every agent execution for analytics
model AgentExecution {
  id              String   @id @default(cuid())
  agentId         String
  taskType        String
  organizationId  String?
  
  input           Json
  output          Json?
  executionTimeMs Int
  success         Boolean  @default(true)
  errorMessage    String?
  
  createdAt       DateTime @default(now())
  
  @@index([agentId])
  @@index([taskType])
  @@index([organizationId])
  @@index([createdAt])
  @@index([success])
}

// Stress Test Run - Records each stress test execution
model StressTestRun {
  id            String   @id @default(cuid())
  scenarioId    String
  scenarioName  String
  agentId       String
  
  totalTests    Int
  passed        Int
  failed        Int
  passRate      Float
  
  results       Json     // Detailed test results
  
  executedBy    String?  // User or system
  createdAt     DateTime @default(now())
  
  @@index([agentId])
  @@index([scenarioId])
  @@index([createdAt])
}

// Build Iteration - Tracks each build cycle and its associated feedback
model BuildIteration {
  id              String   @id @default(cuid())
  version         String   @unique
  commitHash      String?
  
  // What feedback drove this build
  feedbackResolved Json    // Array of feedback IDs
  issuesFixed      Int     @default(0)
  
  // Build metadata
  deployedAt       DateTime?
  deployedBy       String?
  environment      String?  // dev, staging, production
  
  // Verification
  stressTestsPassed Boolean @default(false)
  verificationNotes String?
  
  createdAt        DateTime @default(now())
  
  @@index([version])
  @@index([deployedAt])
}

// Improvement Pattern - Detected patterns for proactive improvement
model ImprovementPattern {
  id              String   @id @default(cuid())
  patternType     String   // recurring_error, performance_degradation, edge_case_gap
  
  agentId         String
  description     String   @db.Text
  occurrences     Int      @default(1)
  lastOccurrence  DateTime
  
  // Resolution
  resolved        Boolean  @default(false)
  resolvedInBuild String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([agentId])
  @@index([patternType])
  @@index([resolved])
}

// User Feedback - Direct user feedback from UI
model UserFeedback {
  id              String   @id @default(cuid())
  organizationId  String
  userId          String?
  
  // Context
  pageUrl         String?
  agentInvolved   String?
  taskInvolved    String?
  
  // Feedback content
  type            String   // bug, feature_request, ux_issue, praise, other
  rating          Int?     // 1-5
  message         String   @db.Text
  
  // Response
  acknowledged    Boolean  @default(false)
  respondedAt     DateTime?
  responseMessage String?
  
  // Linkage
  feedbackLogId   String?  // If converted to formal feedback log
  
  createdAt       DateTime @default(now())
  
  @@index([organizationId])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// CENTURION AGENT - Security Compliance Models
// ============================================================================

// Security Finding - Tracks security issues and vulnerabilities
model SecurityFinding {
  id              String    @id @default(cuid())
  organizationId  String
  
  controlId       String    // Reference to security control (e.g., AC.L2-3.1.1)
  title           String
  description     String    @db.Text
  severity        String    // critical, high, medium, low, informational
  status          String    @default("open") // open, in_progress, remediated, risk_accepted, false_positive
  
  discoveredAt    DateTime  @default(now())
  dueDate         DateTime?
  resolvedAt      DateTime?
  
  evidence        String?   @db.Text
  affectedAssets  String[]
  remediation     Json?     // RemediationPlan object
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([severity])
  @@index([controlId])
}

// Security Posture Snapshot - Point-in-time security posture records
model SecurityPostureSnapshot {
  id               String   @id @default(cuid())
  organizationId   String
  
  overallScore     Int
  frameworkScores  Json     // Record<ComplianceFramework, number>
  openFindings     Int
  criticalFindings Int
  riskLevel        String   // low, medium, high, critical
  
  snapshotDate     DateTime @default(now())
  
  createdAt        DateTime @default(now())

  @@index([organizationId])
  @@index([snapshotDate])
}
