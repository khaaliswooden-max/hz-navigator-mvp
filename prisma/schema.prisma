// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

// Organization managing HUBZone certification
model Organization {
  id              String    @id @default(cuid())
  name            String
  einNumber       String?   @unique
  dunsNumber      String?
  cageCode        String?
  hubzoneNumber   String?   // SBA HUBZone certification number
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  employees       Employee[]
  locations       Location[]
  certifications  Certification[]
  
  // Agent constellation relations
  agentTasks          AgentTask[]
  complianceSnapshots ComplianceSnapshot[]
  complianceAlerts    ComplianceAlert[]
}

// Employee records for residency tracking
model Employee {
  id              String    @id @default(cuid())
  organizationId  String
  firstName       String
  lastName        String
  email           String?
  hireDate        DateTime
  isActive        Boolean   @default(true)
  
  // Address info
  streetAddress   String
  city            String
  state           String
  zipCode         String
  
  // Computed fields stored for performance
  isHubzoneResident Boolean  @default(false)
  hubzoneType       String?  // QCT, QNMC, DDA, etc.
  lastVerified      DateTime?
  
  // Agent constellation fields (2025 HUBZone rules)
  isLegacyEmployee    Boolean   @default(false)  // Grandfathered employee (max 4)
  residencyStartDate  DateTime?                   // For 90-day qualification tracking
  censusTract         String?                     // Census tract ID
  atRiskRedesignation Boolean   @default(false)  // In redesignated area
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
  @@index([isHubzoneResident])
  @@index([isLegacyEmployee])
}

// Business locations
model Location {
  id              String    @id @default(cuid())
  organizationId  String
  name            String
  isPrincipalOffice Boolean @default(false)
  
  streetAddress   String
  city            String
  state           String
  zipCode         String
  
  // Geospatial data
  latitude        Float?
  longitude       Float?
  
  // HUBZone status
  isInHubzone     Boolean   @default(false)
  hubzoneType     String?
  lastVerified    DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
}

// Certification tracking
model Certification {
  id              String    @id @default(cuid())
  organizationId  String
  
  status          CertificationStatus @default(PENDING)
  submittedAt     DateTime?
  approvedAt      DateTime?
  expiresAt       DateTime?
  
  // Compliance snapshot at time of certification
  totalEmployees  Int       @default(0)
  hubzoneResidents Int      @default(0)
  compliancePercent Float   @default(0)
  
  notes           String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  @@index([organizationId])
  @@index([status])
}

enum CertificationStatus {
  PENDING
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  DENIED
  EXPIRED
  RECERTIFICATION_DUE
}

// HUBZone geographic data (populated from SBA data)
model HubzoneArea {
  id              String    @id @default(cuid())
  geoId           String    @unique
  name            String
  state           String
  hubzoneType     String    // QCT, QNMC, DDA, BRAC, etc.
  
  // Census tract or county info
  tractCode       String?
  countyFips      String?
  
  // Effective dates
  effectiveFrom   DateTime
  effectiveTo     DateTime?
  isActive        Boolean   @default(true)
  
  // GeoJSON boundary stored as text (parsed at query time)
  boundaryGeoJson String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([state])
  @@index([hubzoneType])
  @@index([isActive])
}

// Address lookup cache
model AddressLookupCache {
  id              String    @id @default(cuid())
  
  // Input address (normalized)
  inputAddress    String    @unique
  
  // Geocoded result
  latitude        Float
  longitude       Float
  
  // HUBZone result
  isHubzone       Boolean
  hubzoneType     String?
  hubzoneAreaId   String?
  
  // Cache metadata
  expiresAt       DateTime
  createdAt       DateTime  @default(now())
  
  @@index([inputAddress])
  @@index([expiresAt])
}

// ============================================================================
// AGENT CONSTELLATION MODELS
// ============================================================================

// Task queue for all agent operations
model AgentTask {
  id              String    @id @default(cuid())
  agentType       String    // nexus, sentinel, cartograph, workforce, etc.
  taskType        String    // specific operation being performed
  status          String    @default("pending") // pending, processing, completed, failed
  priority        Int       @default(5) // 1 = critical, 5 = routine
  input           Json
  output          Json?
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdAt       DateTime  @default(now())
  completedAt     DateTime?
  executionTimeMs Int?
  errorMessage    String?

  @@index([organizationId])
  @@index([status])
  @@index([agentType])
  @@index([createdAt])
}

// Point-in-time compliance snapshots
model ComplianceSnapshot {
  id                   String   @id @default(cuid())
  organizationId       String
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // Core metrics
  totalEmployees       Int
  hubzoneEmployees     Int
  compliancePercentage Float
  legacyEmployeeCount  Int      @default(0)
  
  // Risk assessment
  riskScore            Float    @default(0)
  complianceStatus     String   // compliant, at_risk, non_compliant, grace_period
  
  // Grace period tracking
  gracePeriodActive    Boolean  @default(false)
  gracePeriodEnd       DateTime?
  
  // Projections (JSON: { days30, days90, days180 })
  projections          Json?
  
  snapshotDate         DateTime @default(now())

  @@index([organizationId])
  @@index([snapshotDate])
  @@index([complianceStatus])
}

// Proactive compliance alerts
model ComplianceAlert {
  id              String    @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  severity        String    // critical, warning, info
  type            String    // compliance_drop, employee_relocation, map_change, etc.
  source          String    @default("sentinel") // which agent generated
  
  title           String
  description     String    @db.Text
  
  actionRequired  Boolean   @default(false)
  suggestedAction String?
  dueDate         DateTime?
  
  status          String    @default("active") // active, acknowledged, resolved, dismissed
  acknowledgedAt  DateTime?
  resolvedAt      DateTime?
  resolution      String?
  
  createdAt       DateTime  @default(now())

  @@index([organizationId])
  @@index([status])
  @@index([severity])
  @@index([createdAt])
}

// Learning events for ML training
model LearningEvent {
  id             String   @id @default(cuid())
  eventType      String   // agent_taskType format
  inputData      Json
  outputData     Json
  outcome        String?  // success, failure, partial
  organizationId String?
  metadata       Json?
  createdAt      DateTime @default(now())

  @@index([eventType])
  @@index([outcome])
  @@index([createdAt])
}

// HUBZone map change tracking
model HubzoneMapChange {
  id                    String    @id @default(cuid())
  censusTract           String
  county                String?
  state                 String?
  
  changeType            String    // designated, redesignated, expired
  previousStatus        String?
  newStatus             String
  
  effectiveDate         DateTime
  expirationDate        DateTime?
  
  detectedAt            DateTime  @default(now())
  affectedOrganizations Json?     // { orgId: true, ... }

  @@index([censusTract])
  @@index([changeType])
  @@index([effectiveDate])
}
